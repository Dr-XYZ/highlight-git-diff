<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Git Diff 比較工具</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    textarea { width: 100%; height: 200px; margin-bottom: 10px; }
    .output { white-space: pre-wrap; background: #f8f8f8; padding: 10px; border: 1px solid #ccc; }
    .added { background-color: #e6ffed; color: #22863a; }
    .deleted { background-color: #ffeef0; color: #cb2431; }
    select, button { margin-bottom: 10px; }
    .line { display: block; margin-bottom: 4px; }
  </style>
</head>
<body>
  <h2>Git Diff 檢視器</h2>
  <select id="mode">
    <option value="line">逐行模式</option>
    <option value="word">逐字模式</option>
  </select>
  <br />
  <textarea id="diffInput" placeholder="貼上 git diff 輸出..."></textarea>
  <br />
  <button onclick="processDiff()">顯示差異</button>
  <div class="output" id="diffOutput"></div>

  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
  <script>
    // 將字串中的 HTML 特殊字元轉義，避免瀏覽器解析成 HTML
    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }

    function processDiff() {
      const mode = document.getElementById('mode').value;
      const input = document.getElementById('diffInput').value;
      const lines = input.split('\n');
      const output = document.getElementById('diffOutput');
      output.innerHTML = '';

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const div = document.createElement('div');
        div.classList.add('line');

        if (mode === 'line') {
          if (line.startsWith('+') && !line.startsWith('+++')) {
            div.classList.add('added');
          } else if (line.startsWith('-') && !line.startsWith('---')) {
            div.classList.add('deleted');
          }
          // 逐行模式純文字顯示，不解析 HTML
          div.textContent = line;
          output.appendChild(div);
        }

        if (mode === 'word') {
          // 先把 HTML 特殊字元轉義
          const escapedLine = escapeHtml(line);

          if (escapedLine.match(/\[-.*?-\]/) || escapedLine.match(/\{\+.*?\+\}/)) {
            // 將 diff 格式轉成 <span> 標籤並渲染
            const replaced = escapedLine
              .replace(/\[-(.*?)\-\]/g, '<span class="deleted">$1</span>')
              .replace(/\{\+(.*?)\+\}/g, '<span class="added">$1</span>');
            div.innerHTML = replaced;
          } else {
            // 沒有差異標記就純文字顯示
            div.textContent = line;
          }
          output.appendChild(div);
        }
      }
    }
  </script>
</body>
</html>
